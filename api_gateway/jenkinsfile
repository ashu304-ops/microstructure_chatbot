pipeline:
  agent:
    docker:
      image: python:3.9-slim
      args: -v /var/run/docker.sock:/var/run/docker.sock
  environment:
    DOCKERHUB_CREDENTIALS: credentials('dockerhub-credentials')
    DOCKER_IMAGE: yourusername/mechanical-chatbot-api:${BUILD_ID}
  stages:
    - stage: Checkout Code
      steps:
        - git:
            url: https://github.com/yourusername/mechanical-chatbot.git
            branch: ${BRANCH_NAME}
        - sh: cd api_gateway
    - stage: Install Dependencies
      steps:
        - sh: pip install --no-cache-dir -r requirements.txt
    - stage: Run Tests
      steps:
        - sh: python -m unittest discover tests
    - stage: Build and Push Docker Image
      when:
        branch: main
      steps:
        - script:
            sh: docker build -t ${DOCKER_IMAGE} -f Dockerfile .
            sh: echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin
            sh: docker push ${DOCKER_IMAGE}
            sh: docker tag ${DOCKER_IMAGE} yourusername/mechanical-chatbot-api:latest
            sh: docker push yourusername/mechanical-chatbot-api:latest
    - stage: Deploy to Kubernetes
      when:
        branch: main
      steps:
        - sh: kubectl apply -f ../kubernetes/manifests.yaml
  post:
    always:
      - sh: echo "Cleaning up temporary files"
      - sh: rm -rf *.pyc
